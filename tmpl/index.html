{{- define "index" -}}
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>
			Home &ndash; CCA Selection System
		</title>
		<link rel="stylesheet" href="/static/style.css" />
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
	</head>
	<body>
		<header>
			<div class="header-content">
				<div class="header-left">
					<h1><a id="site-title" href="/">CCA Selection System</a></h1>
				</div>
				<div class="header-middle">
				</div>
				<div class="header-right">
					<p>{{- .user.Name }} ({{ .user.Department -}})</p>
				</div>
			</div>
		</header>
		<section id="wip-notice">
			<p>
			This site is still a work in progress and may contain bugs! Please contact <a href="mailto:sj-cca@ykpaoschool.cn">the CCA department</a> for CCA selection issues or <a href="mailto:s22537@stu.ykpaoschool.cn">Runxi Yu</a> for website issues.
			</p>
		</section>
		<main class="script-unavailable">
			<div class="message-box">
			<p>
			Unfortunately, JavaScript is required to use this page.
			</p>
			<p>
			I completely agree that ordinary websites that provide information should not require JavaScript. However, a CCA selection site is not a normal website. It needs to handle 600 people sending it requests at once; it needs to update the vacancy numbers live; it needs to responsively check for course consistencies; it needs to provide client-side search functionality; etc. These are better handled with client-side scripting, and we extensively use WebSocket for scalable communications (i.e. sending a few bytes as commands instead of a full-blown form or AJAX request).
			</p>
			<p>
			The source code of this site is available in a repository on <a href="https://git.runxiyu.org/ykps/cca.git">git.rx</a>, <a href="https://git.sr.ht/~runxiyu/cca">SourceHut</a>, and <a href="https://github.com/runxiyu/cca">GitHub</a>. You could also read the JavaScript sent to your browser or something. You could also implement a custom client that speaks the WebSocket-based protocol if interested.
			</p>
			</div>
		</main>
		<main class="script-required">
			<div class="before-connection message-box">
				<p>
				Attempting to establish WebSocket connection.
				</p>
				<p>
				If this message does not disappear soon, it means that one of the following conditions are true:
				</p>
				<ul>
					<li>
						Your browser does not <a href="https://caniuse.com/websockets">support WebSocket</a>, or they are being blocked.
					</li>
					<li>
						The server is overloaded or encountered an error.
					</li>
					<li>
						The network is over-saturated, or you just have a bad network.
					</li>
				</ul>
			</div>
			<div class="broken-connection message-box">
				<p>
				Your WebSocket connection has been closed. This means that one of the following occured:
				</p>
				<ul>
					<li>
						The network is over-saturated and connections cannot be maintained.
					</li>
					<li>
						There was an internal server error that closed your connection.
					</li>
					<li>
						There was an error in the JavaScript running on your browser.
					</li>
				</ul>
				<p>
				<a href="javascript:window.location.reload(true)" class="btn btn-primary">Reconnect</a>
				</p>
			</div>
			<div class="need-connection">
				<div id="alreadyopen">
					<table id="table-of-courses">
						<thead>
							<tr>
								<th scope="col">ID</th>
								<th scope="col">Tick</th>
								<th scope="col"><abbr title="Used/Max"><i>n</i></abbr></th>
								<th scope="col">Name</th>
								<th scope="col">Type</th>
								<th scope="col">Teacher</th>
								<th scope="col">Location</th>
							</tr>
							<tr>
								<th colspan="7" class="tdinput">
									<input type="text" id="search" placeholder="Search..." />
								</th>
							</tr>
						</thead>
						<tbody>
							{{- range .courses }}
							<tr class="courseitem" id="course{{.ID}}">
								<th scope="row">{{.ID}}</th>
								<td><input class="coursecheckbox" type="checkbox" id="tick{{.ID}}" name="tick{{.ID}}", value="tick{{.ID}}"></input></td>
								<td><span id="selected{{.ID}}">{{.Selected}}</span>/<span id="max{{.ID}}">{{.Max}}</span></td>
								<td>{{.Title}}</td>
								<td id="type{{.ID}}">{{.Type}}</td>
								<td>{{.Teacher}}</td>
								<td>{{.Location}}</td>
							</tr>
							{{- end }}
						</tbody>
						<tfoot>
							<tr>
								<td class="th-like" colspan="7">
									<div class="flex-justify">
										<div class="left">
										</div>
										<div class="right">
											<button id="confirmbutton" class="btn-primary btn">Confirm</button>
										</div>
									</div>
								</td>
							</tr>
						</tfoot>
					</table>
				</div>
				<!--
					This should be handled in the JavaScript sometime later.
					<div id="notopenyet" class="message-box">
						<p>
						CCA selections are not currently open.
						</p>
					</div>
				-->
			</div>
		</main>
		<script src="static/main.js"></script>
		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const search = document.getElementById("search")
				search.addEventListener("input", () => {
					const s = search.value.toLowerCase().trim().normalize('NFD')
					document.querySelectorAll(".courseitem").forEach(c => {
						const m = c.textContent.toLowerCase().normalize('NFD').includes(s)
						c.hidden = (!m) && (s.length > 0)
					})
				})
			})
		</script>
	</body>
</html>
{{- end -}}
